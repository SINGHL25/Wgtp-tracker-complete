<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WGTP Training Tracker - Complete</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .last-updated {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85em;
        }

        .auto-save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: none;
            animation: slideIn 0.3s;
            z-index: 1000;
        }

        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1em;
            font-weight: 500;
            color: #495057;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .nav-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }

        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.5s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .trainee-management {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            padding: 20px;
            background: linear-gradient(135deg, #e7f3ff 0%, #f0e7ff 100%);
            border-radius: 10px;
            flex-wrap: wrap;
        }

        .trainee-management label {
            font-weight: 600;
            color: #495057;
        }

        .trainee-management select {
            padding: 10px 20px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            min-width: 200px;
        }

        .trainee-actions {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .week-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 5px solid #667eea;
        }

        .week-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .week-title {
            font-size: 1.5em;
            color: #2c3e50;
            font-weight: 600;
        }

        .week-title-editable {
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .week-title-editable:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .week-title-editable[contenteditable="true"] {
            background: #fff;
            border: 2px solid #667eea;
        }

        .week-progress {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .progress-bar {
            width: 200px;
            height: 10px;
            background: #dee2e6;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        .session-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 15px;
        }

        .session-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 500;
            font-size: 0.95em;
        }

        .session-table td {
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .session-table tr:last-child td {
            border-bottom: none;
        }

        .session-table tr:hover {
            background: #f8f9fa;
        }

        .editable-input {
            width: 100%;
            padding: 8px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 0.9em;
            transition: border-color 0.3s;
        }

        .editable-input:focus {
            outline: none;
            border-color: #667eea;
            background: #f0f7ff;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            user-select: none;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-in-progress {
            background: #cfe2ff;
            color: #084298;
        }

        .status-completed {
            background: #d1e7dd;
            color: #0f5132;
        }

        .status-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .add-session-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.3s;
        }

        .add-session-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .delete-row-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.3s;
        }

        .delete-row-btn:hover {
            background: #c82333;
        }

        .feedback-section {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border: 2px dashed #dee2e6;
        }

        .feedback-form {
            display: grid;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 500;
            margin-bottom: 8px;
            color: #495057;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            min-height: 300px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #adb5bd;
        }

        .close:hover {
            color: #495057;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d1e7dd;
            color: #0f5132;
            border-left: 4px solid #28a745;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        .feedback-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .feedback-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .feedback-meta {
            font-size: 0.9em;
            color: #6c757d;
        }

        .rating-stars {
            color: #ffc107;
            font-size: 1.2em;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            .trainee-actions {
                margin-left: 0;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="auto-save-indicator" id="autoSaveIndicator">‚úì Auto-saved</div>

    <div class="container">
        <div class="header">
            <div class="last-updated" id="lastUpdated">Last updated: Never</div>
            <h1>üéØ WGTP Training Tracker</h1>
            <p>Collaborative Dashboard for L1/L2 Support Engineers</p>
        </div>

        <div class="nav-tabs" id="navTabs">
            <button class="nav-tab active" data-tab="dashboard">üìä Dashboard</button>
            <button class="nav-tab" data-tab="week1">Week 1</button>
            <button class="nav-tab" data-tab="week2">Week 2</button>
            <button class="nav-tab" data-tab="week3">Week 3</button>
            <button class="nav-tab" data-tab="week4">Week 4</button>
            <button class="nav-tab" data-tab="week5">Week 5</button>
            <button class="nav-tab" data-tab="week6">Week 6</button>
            <button class="nav-tab" data-tab="feedback">üí¨ Feedback</button>
            <button class="nav-tab" data-tab="reports">üìà Reports</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="trainee-management">
                <label for="traineeSelect">Select Trainee:</label>
                <select id="traineeSelect"></select>
                <div class="trainee-actions">
                    <button class="btn btn-primary" id="addTraineeBtn">+ Add Trainee</button>
                    <button class="btn btn-danger" id="removeTraineeBtn">üóëÔ∏è Remove</button>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="stat-card">
                    <h3>Overall Progress</h3>
                    <div class="stat-value" id="overallProgress">0%</div>
                    <div class="stat-label">Training Completion</div>
                </div>
                <div class="stat-card">
                    <h3>Sessions Completed</h3>
                    <div class="stat-value" id="sessionsCompleted">0/0</div>
                    <div class="stat-label">Total Sessions</div>
                </div>
                <div class="stat-card">
                    <h3>Current Week</h3>
                    <div class="stat-value" id="currentWeek">1</div>
                    <div class="stat-label">of 6 weeks</div>
                </div>
                <div class="stat-card">
                    <h3>Average Rating</h3>
                    <div class="stat-value" id="avgRating">0.0</div>
                    <div class="stat-label">‚≠ê Performance</div>
                </div>
            </div>

            <div class="chart-container"><div id="progressChart"></div></div>
            <div class="chart-container"><div id="weeklyStatusChart"></div></div>
            <div class="chart-container"><div id="skillsRadarChart"></div></div>
        </div>

        <!-- Week Tabs -->
        <div id="week1" class="tab-content"></div>
        <div id="week2" class="tab-content"></div>
        <div id="week3" class="tab-content"></div>
        <div id="week4" class="tab-content"></div>
        <div id="week5" class="tab-content"></div>
        <div id="week6" class="tab-content"></div>

        <!-- Feedback Tab -->
        <div id="feedback" class="tab-content">
            <h2>üìù Training Feedback</h2>
            <div class="feedback-section">
                <h3>Submit New Feedback</h3>
                <div class="feedback-form">
                    <div class="form-group">
                        <label>Week:</label>
                        <select id="feedbackWeek">
                            <option value="overall">Overall Training</option>
                            <option value="week1">Week 1</option>
                            <option value="week2">Week 2</option>
                            <option value="week3">Week 3</option>
                            <option value="week4">Week 4</option>
                            <option value="week5">Week 5</option>
                            <option value="week6">Week 6</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Type:</label>
                        <select id="feedbackType">
                            <option value="strength">üí™ Strength</option>
                            <option value="improvement">üéØ Improvement</option>
                            <option value="concern">‚ö†Ô∏è Concern</option>
                            <option value="achievement">üèÜ Achievement</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Rating:</label>
                        <select id="feedbackRating">
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê</option>
                            <option value="2">‚≠ê‚≠ê</option>
                            <option value="1">‚≠ê</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Comments:</label>
                        <textarea id="feedbackComments" placeholder="Enter feedback..."></textarea>
                    </div>
                    <button class="btn btn-primary" id="submitFeedbackBtn">Submit Feedback</button>
                </div>
            </div>
            <div style="margin-top: 30px;">
                <h3>Feedback History</h3>
                <div id="feedbackHistory"></div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports" class="tab-content">
            <h2>üìä Training Analytics</h2>
            <div class="chart-container"><div id="timelineChart"></div></div>
            <div class="chart-container"><div id="performanceTrendChart"></div></div>
            <div class="chart-container"><div id="competencyMatrix"></div></div>
            <div style="display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap;">
                <button class="btn btn-primary" id="exportPDFBtn">üìÑ Export PDF</button>
                <button class="btn btn-secondary" id="exportExcelBtn">üìä Export Excel</button>
                <button class="btn btn-success" id="printBtn">üñ®Ô∏è Print</button>
            </div>
        </div>
    </div>

    <!-- Add Trainee Modal -->
    <div id="addTraineeModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeModal">&times;</span>
            <h2>Add New Trainee</h2>
            <div class="feedback-form">
                <div class="form-group">
                    <label>Name: *</label>
                    <input type="text" id="newTraineeName" placeholder="Enter name...">
                </div>
                <div class="form-group">
                    <label>Employee ID:</label>
                    <input type="text" id="newTraineeID" placeholder="Optional...">
                </div>
                <div class="form-group">
                    <label>Start Date:</label>
                    <input type="date" id="newTraineeStartDate">
                </div>
                <button class="btn btn-primary" id="confirmAddTrainee">Add Trainee</button>
            </div>
        </div>
    </div>

    <script>
        const WEEK_DATA = {
            week1: { title: "Week 1: Introduction to WGTP System & Monitoring Basics", sessions: [
                { name: "1.1: WGTP System Overview (Recap)", duration: "2 hours" },
                { name: "1.2: Introduction to TOMO", duration: "3 hours" },
                { name: "1.3: Introduction to Icinga", duration: "3 hours" },
                { name: "1.4: Introduction to Jira", duration: "2.5 hours" }
            ]},
            week2: { title: "Week 2: RSS Equipment Fundamentals", sessions: [
                { name: "2.1: RSS Equipment - TSC", duration: "3 hours" },
                { name: "2.2: RSS Equipment - VDC", duration: "3 hours" },
                { name: "2.3: RSS Equipment - VRX", duration: "2.5 hours" },
                { name: "2.4: Basic Troubleshooting", duration: "3 hours" }
            ]},
            week3: { title: "Week 3: Integrated Monitoring", sessions: [
                { name: "3.1: Advanced TOMO & Icinga", duration: "3.5 hours" },
                { name: "3.2: TSC Issues Resolution", duration: "3.5 hours" },
                { name: "3.3: VDC & VRX Issues", duration: "3.5 hours" },
                { name: "3.4: Ticket Management", duration: "2.5 hours" }
            ]},
            week4: { title: "Week 4: Live DC Practical - Part 1", sessions: [
                { name: "4.1: DC Environment", duration: "3 hours" },
                { name: "4.2: Live Monitoring", duration: "3.5 hours" },
                { name: "4.3: Equipment Checks", duration: "3.5 hours" },
                { name: "4.4: Incident Response", duration: "4 hours" }
            ]},
            week5: { title: "Week 5: Advanced Troubleshooting", sessions: [
                { name: "5.1: Multi-Component Issues", duration: "4 hours" },
                { name: "5.2: Performance Optimization", duration: "3 hours" },
                { name: "5.3: Independent DC Practical", duration: "6 hours" },
                { name: "5.4: Advanced Reporting", duration: "3 hours" }
            ]},
            week6: { title: "Week 6: Competency Assessment", sessions: [
                { name: "6.1: Scenario Assessment", duration: "4.5 hours" },
                { name: "6.2: Production Assessment", duration: "6 hours" },
                { name: "6.3: Knowledge Gaps Review", duration: "3 hours" },
                { name: "6.4: Handover to BAU", duration: "2 hours" }
            ]}
        };

        let data = { trainees: {}, lastUpdate: null };
        let currentTrainee = null;
        let saveTimeout = null;

        function init() {
            loadData();
            if (Object.keys(data.trainees).length === 0) {
                const id = 'trainee_' + Date.now();
                data.trainees[id] = createTrainee("Trainee 1", "EMP001");
                saveData();
            }
            setupEventListeners();
            loadTraineeSelect();
            currentTrainee = document.getElementById('traineeSelect').value;
            generateWeeks();
            loadCurrentTrainee();
            updateDashboard();
            renderCharts();
            setInterval(checkUpdates, 5000);
        }

        function createTrainee(name, empId) {
            const weeks = {};
            Object.keys(WEEK_DATA).forEach(wk => {
                weeks[wk] = {
                    title: WEEK_DATA[wk].title,
                    sessions: WEEK_DATA[wk].sessions.map((s, i) => ({
                        id: Date.now() + '_' + i,
                        name: s.name,
                        duration: s.duration,
                        status: 'Pending',
                        date: '',
                        notes: ''
                    })),
                    feedback: { trainer: '', self: '', rating: '', cert: '' }
                };
            });
            return {
                name: name,
                empId: empId || 'N/A',
                startDate: new Date().toISOString().split('T')[0],
                weeks: weeks,
                feedbackList: []
            };
        }

        function setupEventListeners() {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });
            document.getElementById('traineeSelect').addEventListener('change', changeTrainee);
            document.getElementById('addTraineeBtn').addEventListener('click', () => showModal(true));
            document.getElementById('removeTraineeBtn').addEventListener('click', removeTrainee);
            document.getElementById('closeModal').addEventListener('click', () => showModal(false));
            document.getElementById('confirmAddTrainee').addEventListener('click', addTrainee);
            document.getElementById('submitFeedbackBtn').addEventListener('click', submitFeedback);
            document.getElementById('exportPDFBtn').addEventListener('click', () => window.print());
            document.getElementById('exportExcelBtn').addEventListener('click', exportCSV);
            document.getElementById('printBtn').addEventListener('click', () => window.print());
            window.addEventListener('click', e => {
                if (e.target.id === 'addTraineeModal') showModal(false);
            });
        }

        function generateWeeks() {
            for (let i = 1; i <= 6; i++) {
                const wk = 'week' + i;
                const container = document.getElementById(wk);
                container.innerHTML = `
                    <div class="week-section">
                        <div class="week-header">
                            <h2 class="week-title">
                                <span class="week-title-editable" contenteditable="true" data-week="${wk}">${WEEK_DATA[wk].title}</span>
                            </h2>
                            <div class="week-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="${wk}_progress"></div>
                                </div>
                                <span id="${wk}_progress_text">0%</span>
                            </div>
                        </div>
                        <table class="session-table">
                            <thead>
                                <tr>
                                    <th style="width:30%">Session</th>
                                    <th style="width:12%">Duration</th>
                                    <th style="width:12%">Status</th>
                                    <th style="width:15%">Date</th>
                                    <th style="width:23%">Notes</th>
                                    <th style="width:8%">Action</th>
                                </tr>
                            </thead>
                            <tbody id="${wk}_tbody"></tbody>
                        </table>
                        <button class="add-session-btn" data-week="${wk}">‚ûï Add Session</button>
                        <div class="feedback-section">
                            <h3>Week ${i} Feedback</h3>
                            <div class="feedback-form">
                                <div class="form-group">
                                    <label>Trainer Comments:</label>
                                    <textarea id="${wk}_trainer" placeholder="Trainer feedback..."></textarea>
                                </div>
                                <div class="form-group">
                                    <label>Self-Assessment:</label>
                                    <textarea id="${wk}_self" placeholder="Your progress..."></textarea>
                                </div>
                                <div class="form-group">
                                    <label>Rating:</label>
                                    <select id="${wk}_rating">
                                        <option value="">Select...</option>
                                        <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
                                        <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê</option>
                                        <option value="3">‚≠ê‚≠ê‚≠ê</option>
                                        <option value="2">‚≠ê‚≠ê</option>
                                        <option value="1">‚≠ê</option>
                                    </select>
                                </div>
                                ${i === 6 ? `
                                <div class="form-group">
                                    <label>Certification:</label>
                                    <select id="${wk}_cert">
                                        <option value="">Select...</option>
                                        <option value="certified">‚úÖ Certified</option>
                                        <option value="additional">‚ö†Ô∏è Additional Training</option>
                                        <option value="not_ready">‚ùå Not Ready</option>
                                    </select>
                                </div>` : ''}
                            </div>
                        </div>
                    </div>
                `;

                // Add event listeners
                document.querySelector(`[data-week="${wk}"].week-title-editable`).addEventListener('blur', function() {
                    if (currentTrainee) {
                        data.trainees[currentTrainee].weeks[wk].title = this.textContent.trim();
                        autoSave();
                    }
                });

                document.querySelector(`[data-week="${wk}"].add-session-btn`).addEventListener('click', function() {
                    addSession(wk);
                });

                ['trainer', 'self', 'rating', 'cert'].forEach(field => {
                    const el = document.getElementById(`${wk}_${field}`);
                    if (el) {
                        el.addEventListener('change', () => {
                            if (currentTrainee) {
                                data.trainees[currentTrainee].weeks[wk].feedback[field] = el.value;
                                autoSave();
                                updateDashboard();
                            }
                        });
                    }
                });
            }
        }

        function renderSessions(wk) {
            if (!currentTrainee) return;
            const tbody = document.getElementById(wk + '_tbody');
            const sessions = data.trainees[currentTrainee].weeks[wk].sessions;
            tbody.innerHTML = sessions.map((s, i) => `
                <tr>
                    <td><input class="editable-input" value="${s.name}" data-week="${wk}" data-idx="${i}" data-field="name"></td>
                    <td><input class="editable-input" value="${s.duration}" data-week="${wk}" data-idx="${i}" data-field="duration"></td>
                    <td><span class="status-badge status-${s.status.toLowerCase().replace(/\s/g,'-')}" data-week="${wk}" data-idx="${i}">${s.status}</span></td>
                    <td><input type="date" class="editable-input" value="${s.date}" data-week="${wk}" data-idx="${i}" data-field="date"></td>
                    <td><input class="editable-input" value="${s.notes}" data-week="${wk}" data-idx="${i}" data-field="notes"></td>
                    <td><button class="delete-row-btn" data-week="${wk}" data-idx="${i}">üóëÔ∏è</button></td>
                </tr>
            `).join('');

            // Add listeners
            tbody.querySelectorAll('.editable-input').forEach(inp => {
                inp.addEventListener('change', function() {
                    const {week, idx, field} = this.dataset;
                    data.trainees[currentTrainee].weeks[week].sessions[idx][field] = this.value;
                    autoSave();
                });
            });

            tbody.querySelectorAll('.status-badge').forEach(badge => {
                badge.addEventListener('click', function() {
                    const {week, idx} = this.dataset;
                    const statuses = ['Pending', 'In Progress', 'Completed'];
                    const curr = data.trainees[currentTrainee].weeks[week].sessions[idx].status;
                    const next = statuses[(statuses.indexOf(curr) + 1) % 3];
                    data.trainees[currentTrainee].weeks[week].sessions[idx].status = next;
                    renderSessions(week);
                    updateProgress(week);
                    updateDashboard();
                    autoSave();
                });
            });

            tbody.querySelectorAll('.delete-row-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (confirm('Delete this session?')) {
                        const {week, idx} = this.dataset;
                        data.trainees[currentTrainee].weeks[week].sessions.splice(idx, 1);
                        renderSessions(week);
                        updateProgress(week);
                        updateDashboard();
                        autoSave();
                    }
                });
            });

            updateProgress(wk);
        }

        function addSession(wk) {
            if (!currentTrainee) return;
            data.trainees[currentTrainee].weeks[wk].sessions.push({
                id: Date.now(),
                name: 'New Session',
                duration: '1 hour',
                status: 'Pending',
                date: '',
                notes: ''
            });
            renderSessions(wk);
            updateDashboard();
            autoSave();
        }

        function updateProgress(wk) {
            if (!currentTrainee) return;
            const sessions = data.trainees[currentTrainee].weeks[wk].sessions;
            const done = sessions.filter(s => s.status === 'Completed').length;
            const pct = sessions.length ? Math.round(done / sessions.length * 100) : 0;
            document.getElementById(wk + '_progress').style.width = pct + '%';
            document.getElementById(wk + '_progress_text').textContent = pct + '%';
        }

        function loadCurrentTrainee() {
            if (!currentTrainee) return;
            const t = data.trainees[currentTrainee];
            Object.keys(t.weeks).forEach(wk => {
                const w = t.weeks[wk];
                const titleEl = document.querySelector(`[data-week="${wk}"].week-title-editable`);
                if (titleEl) titleEl.textContent = w.title;
                renderSessions(wk);
                ['trainer', 'self', 'rating', 'cert'].forEach(f => {
                    const el = document.getElementById(`${wk}_${f}`);
                    if (el) el.value = w.feedback[f] || '';
                });
            });
            renderFeedbackHistory();
        }

        function changeTrainee() {
            currentTrainee = document.getElementById('traineeSelect').value;
            loadCurrentTrainee();
            updateDashboard();
            renderCharts();
        }

        function loadTraineeSelect() {
            const sel = document.getElementById('traineeSelect');
            sel.innerHTML = Object.keys(data.trainees).map(id =>
                `<option value="${id}">${data.trainees[id].name}</option>`
            ).join('');
        }

        function showModal(show) {
            document.getElementById('addTraineeModal').style.display = show ? 'block' : 'none';
        }

        function addTrainee() {
            const name = document.getElementById('newTraineeName').value.trim();
            if (!name) return alert('Enter name');
            const id = 'trainee_' + Date.now();
            data.trainees[id] = createTrainee(name, document.getElementById('newTraineeID').value.trim());
            loadTraineeSelect();
            document.getElementById('traineeSelect').value = id;
            currentTrainee = id;
            loadCurrentTrainee();
            updateDashboard();
            saveData();
            showModal(false);
            document.getElementById('newTraineeName').value = '';
            document.getElementById('newTraineeID').value = '';
        }

        function removeTrainee() {
            if (Object.keys(data.trainees).length <= 1) return alert('Cannot remove last trainee');
            if (confirm('Remove this trainee?')) {
                delete data.trainees[currentTrainee];
                loadTraineeSelect();
                currentTrainee = document.getElementById('traineeSelect').value;
                loadCurrentTrainee();
                updateDashboard();
                saveData();
            }
        }

        function updateDashboard() {
            if (!currentTrainee) return;
            const t = data.trainees[currentTrainee];
            let total = 0, done = 0, rSum = 0, rCnt = 0, currWeek = 1;
            Object.keys(t.weeks).forEach((wk, i) => {
                const sessions = t.weeks[wk].sessions;
                total += sessions.length;
                const comp = sessions.filter(s => s.status === 'Completed').length;
                done += comp;
                if (comp < sessions.length && currWeek === i + 1) currWeek = i + 1;
                else if (comp === sessions.length) currWeek = i + 2;
                const r = t.weeks[wk].feedback.rating;
                if (r) { rSum += parseInt(r); rCnt++; }
            });
            document.getElementById('overallProgress').textContent = (total ? Math.round(done/total*100) : 0) + '%';
            document.getElementById('sessionsCompleted').textContent = done + '/' + total;
            document.getElementById('currentWeek').textContent = Math.min(currWeek, 6);
            document.getElementById('avgRating').textContent = rCnt ? (rSum/rCnt).toFixed(1) : '0.0';
        }

        function submitFeedback() {
            if (!currentTrainee) return;
            const comments = document.getElementById('feedbackComments').value.trim();
            if (!comments) return alert('Enter comments');
            data.trainees[currentTrainee].feedbackList.push({
                week: document.getElementById('feedbackWeek').value,
                type: document.getElementById('feedbackType').value,
                rating: parseInt(document.getElementById('feedbackRating').value),
                comments: comments,
                date: new Date().toISOString()
            });
            document.getElementById('feedbackComments').value = '';
            renderFeedbackHistory();
            saveData();
        }

        function renderFeedbackHistory() {
            const cont = document.getElementById('feedbackHistory');
            if (!currentTrainee || !data.trainees[currentTrainee].feedbackList.length) {
                cont.innerHTML = '<p style="text-align:center;color:#6c757d;padding:20px">No feedback yet</p>';
                return;
            }
            const icons = {strength:'üí™',improvement:'üéØ',concern:'‚ö†Ô∏è',achievement:'üèÜ'};
            cont.innerHTML = [...data.trainees[currentTrainee].feedbackList].reverse().map(f => `
                <div class="feedback-item">
                    <div class="feedback-header">
                        <div><strong>${icons[f.type]} ${f.week === 'overall' ? 'Overall' : 'Week ' + f.week.replace('week','')}</strong>
                        <span class="feedback-meta"> ‚Ä¢ ${new Date(f.date).toLocaleString()}</span></div>
                        <div class="rating-stars">${'‚≠ê'.repeat(f.rating)}</div>
                    </div>
                    <p>${f.comments}</p>
                </div>
            `).join('');
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            if (tab === 'dashboard' || tab === 'reports') {
                updateDashboard();
                setTimeout(renderCharts, 100);
            }
        }

        function renderCharts() {
            if (!currentTrainee) return;
            renderProgressChart();
            renderWeeklyChart();
            renderSkillsChart();
            renderTimelineChart();
            renderTrendChart();
            renderMatrixChart();
        }

        function renderProgressChart() {
            const t = data.trainees[currentTrainee];
            let done = 0, prog = 0, pend = 0;
            Object.values(t.weeks).forEach(w => {
                w.sessions.forEach(s => {
                    if (s.status === 'Completed') done++;
                    else if (s.status === 'In Progress') prog++;
                    else pend++;
                });
            });
            Plotly.newPlot('progressChart', [{
                values: [done, prog, pend],
                labels: ['Completed', 'In Progress', 'Pending'],
                type: 'pie',
                marker: {colors: ['#28a745', '#007bff', '#ffc107']}
            }], {title: 'Overall Progress', height: 400}, {responsive: true});
        }

        function renderWeeklyChart() {
            const t = data.trainees[currentTrainee];
            const weeks = [], done = [], prog = [], pend = [];
            for (let i = 1; i <= 6; i++) {
                weeks.push('Week ' + i);
                const w = t.weeks['week' + i];
                done.push(w.sessions.filter(s => s.status === 'Completed').length);
                prog.push(w.sessions.filter(s => s.status === 'In Progress').length);
                pend.push(w.sessions.filter(s => s.status === 'Pending').length);
            }
            Plotly.newPlot('weeklyStatusChart', [
                {x: weeks, y: done, name: 'Completed', type: 'bar', marker: {color: '#28a745'}},
                {x: weeks, y: prog, name: 'In Progress', type: 'bar', marker: {color: '#007bff'}},
                {x: weeks, y: pend, name: 'Pending', type: 'bar', marker: {color: '#ffc107'}}
            ], {title: 'Week-wise Status', barmode: 'stack', height: 400}, {responsive: true});
        }

        function renderSkillsChart() {
            const skills = ['TOMO', 'Icinga', 'Jira', 'TSC', 'VDC', 'VRX', 'Troubleshooting', 'Communication'];
            const t = data.trainees[currentTrainee];
            let total = 0;
            Object.values(t.weeks).forEach(w => total += w.sessions.filter(s => s.status === 'Completed').length);
            const vals = skills.map(() => Math.min(100, total * 4 + Math.random() * 20));
            Plotly.newPlot('skillsRadarChart', [{
                type: 'scatterpolar',
                r: vals,
                theta: skills,
                fill: 'toself',
                marker: {color: '#667eea'}
            }], {title: 'Skills Competency', height: 500, polar: {radialaxis: {range: [0, 100]}}}, {responsive: true});
        }

        function renderTimelineChart() {
            const t = data.trainees[currentTrainee];
            const tasks = [];
            Object.keys(t.weeks).forEach((wk, i) => {
                t.weeks[wk].sessions.forEach((s, j) => {
                    if (s.date && s.status === 'Completed') {
                        tasks.push({x: s.date, y: `W${i+1}-S${j+1}`, text: s.name});
                    }
                });
            });
            if (!tasks.length) {
                document.getElementById('timelineChart').innerHTML = '<p style="text-align:center;padding:40px;color:#6c757d">No completed sessions with dates</p>';
                return;
            }
            Plotly.newPlot('timelineChart', [{
                x: tasks.map(t => t.x),
                y: tasks.map(t => t.y),
                text: tasks.map(t => t.text),
                type: 'scatter',
                mode: 'markers',
                marker: {color: '#28a745', size: 12}
            }], {title: 'Timeline', height: 500}, {responsive: true});
        }

        function renderTrendChart() {
            const t = data.trainees[currentTrainee];
            const weeks = [], ratings = [];
            for (let i = 1; i <= 6; i++) {
                const r = t.weeks['week' + i].feedback.rating;
                if (r) {
                    weeks.push('Week ' + i);
                    ratings.push(parseInt(r));
                }
            }
            if (!ratings.length) {
                document.getElementById('performanceTrendChart').innerHTML = '<p style="text-align:center;padding:40px;color:#6c757d">No ratings yet</p>';
                return;
            }
            Plotly.newPlot('performanceTrendChart', [{
                x: weeks,
                y: ratings,
                type: 'scatter',
                mode: 'lines+markers',
                line: {color: '#667eea', width: 3},
                marker: {size: 10}
            }], {title: 'Performance Trend', height: 400, yaxis: {range: [0, 6]}}, {responsive: true});
        }

        function renderMatrixChart() {
            const t = data.trainees[currentTrainee];
            const skills = ['TOMO', 'Icinga', 'Jira', 'TSC', 'VDC', 'VRX', 'Troubleshooting', 'Comm'];
            const zData = [];
            for (let i = 1; i <= 6; i++) {
                const w = t.weeks['week' + i];
                const pct = Math.round(w.sessions.filter(s => s.status === 'Completed').length / w.sessions.length * 100);
                zData.push(skills.map(() => pct));
            }
            Plotly.newPlot('competencyMatrix', [{
                z: zData,
                x: skills,
                y: ['W1', 'W2', 'W3', 'W4', 'W5', 'W6'],
                type: 'heatmap',
                colorscale: [[0, '#fff3cd'], [0.5, '#cfe2ff'], [1, '#d1e7dd']]
            }], {title: 'Competency Matrix', height: 400}, {responsive: true});
        }

        function autoSave() {
            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                saveData();
                const ind = document.getElementById('autoSaveIndicator');
                ind.style.display = 'block';
                setTimeout(() => ind.style.display = 'none', 2000);
            }, 500);
        }

        function saveData() {
            data.lastUpdate = new Date().toISOString();
            localStorage.setItem('wgtpData', JSON.stringify(data));
            document.getElementById('lastUpdated').textContent = 'Last updated: ' + new Date(data.lastUpdate).toLocaleString();
        }

        function loadData() {
            const saved = localStorage.getItem('wgtpData');
            if (saved) {
                try {
                    data = JSON.parse(saved);
                } catch(e) {
                    data = {trainees: {}, lastUpdate: null};
                }
            }
        }

        function checkUpdates() {
            const saved = localStorage.getItem('wgtpData');
            if (saved) {
                const check = JSON.parse(saved);
                if (check.lastUpdate !== data.lastUpdate) {
                    data = check;
                    loadCurrentTrainee();
                    updateDashboard();
                    renderCharts();
                    document.getElementById('lastUpdated').textContent = 'Last updated: ' + new Date(data.lastUpdate).toLocaleString();
                }
            }
        }

        function exportCSV() {
            if (!currentTrainee) return;
            const t = data.trainees[currentTrainee];
            let csv = 'WGTP Training Report\n';
            csv += 'Trainee: ' + t.name + '\n';
            csv += 'Employee ID: ' + t.empId + '\n\n';
            csv += 'Week,Session,Duration,Status,Date,Notes\n';
            Object.keys(t.weeks).forEach((wk, i) => {
                t.weeks[wk].sessions.forEach(s => {
                    csv += `Week ${i+1},"${s.name}","${s.duration}",${s.status},${s.date},"${s.notes.replace(/,/g,';')}"\n`;
                });
            });
            const blob = new Blob([csv], {type: 'text/csv'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'training_' + t.name.replace(/\s/g, '_') + '.csv';
            a.click();
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>
